#!/bin/bash
# =============================================================================
# æäº¤å‰ä»£ç å®¡æŸ¥ - è°ƒç”¨ Claude Agent ç‰ˆæœ¬
# 
# è¿™ä¸ªè„šæœ¬æ˜¯ Hook çš„è§¦å‘å…¥å£ï¼Œå®ƒä¼šï¼š
# 1. æ”¶é›†å¾…å®¡æŸ¥çš„æ–‡ä»¶ä¿¡æ¯
# 2. è°ƒç”¨ code-reviewer agent æ‰§è¡Œæ™ºèƒ½å®¡æŸ¥
# 3. Agent ä¼šå‚è€ƒ security-review skill çš„æ ‡å‡†
# =============================================================================

set -e

input=$(cat)

echo "[Pre-Commit] ğŸ” å‡†å¤‡è°ƒç”¨ Claude Agent è¿›è¡Œä»£ç å®¡æŸ¥..." >&2

# è·å–æš‚å­˜æ–‡ä»¶
staged_files=$(git diff --cached --name-only 2>/dev/null || echo "")

if [ -z "$staged_files" ]; then
  echo "[Pre-Commit] â„¹ï¸  æ²¡æœ‰æš‚å­˜çš„æ–‡ä»¶ï¼Œè·³è¿‡å®¡æŸ¥" >&2
  echo "$input"
  exit 0
fi

# è·å– diff å†…å®¹ä¾› Agent å®¡æŸ¥
diff_content=$(git diff --cached 2>/dev/null || echo "")

echo "[Pre-Commit] ğŸ“ å¾…å®¡æŸ¥æ–‡ä»¶:" >&2
echo "$staged_files" | while read -r f; do [ -n "$f" ] && echo "  - $f" >&2; done

# =============================================================================
# æ–¹å¼ 1: é€šè¿‡ Claude CLI è°ƒç”¨ Agentï¼ˆæ¨èï¼‰
# =============================================================================
# 
# å¦‚æœä½ å®‰è£…äº† Claude CLIï¼Œå¯ä»¥ç›´æ¥è°ƒç”¨ agentï¼š
#
# claude --agent code-reviewer --input "è¯·å®¡æŸ¥ä»¥ä¸‹ä»£ç å˜æ›´ï¼š
# 
# æ–‡ä»¶åˆ—è¡¨ï¼š
# $staged_files
# 
# Diff å†…å®¹ï¼š
# $diff_content
# 
# è¯·æŒ‰ç…§ security-review skill çš„æ ‡å‡†è¿›è¡Œæ£€æŸ¥ï¼Œè¾“å‡ºï¼š
# 1. CRITICAL é—®é¢˜ï¼ˆå¿…é¡»é˜»æ­¢æäº¤ï¼‰
# 2. WARNING é—®é¢˜ï¼ˆå»ºè®®ä¿®å¤ï¼‰
# 3. æ˜¯å¦é€šè¿‡å®¡æŸ¥ï¼ˆPASS/FAILï¼‰
# "
#
# æ ¹æ® agent çš„è¾“å‡ºå†³å®šæ˜¯å¦é˜»æ­¢æäº¤

# =============================================================================
# æ–¹å¼ 2: è¾“å‡ºä¿¡æ¯ï¼Œè®©å½“å‰ Claude ä¼šè¯å¤„ç†
# =============================================================================
#
# ç”±äº Hook åœ¨å·¥å…·æ‰§è¡Œå‰è§¦å‘ï¼Œæˆ‘ä»¬å¯ä»¥ï¼š
# 1. è¾“å‡ºè­¦å‘Šä¿¡æ¯
# 2. è®© Claude åœ¨æ‰§è¡Œ commit å‰å…ˆè¿›è¡Œå®¡æŸ¥

echo "" >&2
echo "[Pre-Commit] â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" >&2
echo "[Pre-Commit] ğŸ’¡ å»ºè®®ï¼šåœ¨æäº¤å‰ä½¿ç”¨ /code-review å‘½ä»¤è¿›è¡Œå®¡æŸ¥" >&2
echo "[Pre-Commit] æˆ–è€…è®© Claude è°ƒç”¨ code-reviewer agent" >&2
echo "[Pre-Commit] â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" >&2
echo "" >&2

# ç»§ç»­æ‰§è¡Œï¼ˆä¸é˜»æ­¢ï¼‰ï¼Œè®© Claude å†³å®š
echo "$input"
